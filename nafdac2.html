<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NAFDAC Scanner & Verifier</title>
<style>
  :root{--accent:#007b5e;--danger:#c92a2a;--card:#ffffff;--bg:#f4f6f8}
  body{font-family:Inter, Roboto, Arial, sans-serif;background:var(--bg);margin:0;padding:18px;display:flex;align-items:flex-start;justify-content:center;min-height:100vh}
  .app{width:100%;max-width:980px;background:linear-gradient(180deg,#fff,#fbfdff);border-radius:12px;box-shadow:0 10px 30px rgba(10,20,30,0.08);padding:18px;display:grid;grid-template-columns:420px 1fr;gap:18px}
  header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between}
  h1{margin:0;font-size:18px;color:var(--accent)}
  p.hint{margin:0;color:#666;font-size:13px}
  /* left column */
  .cam-card{background:var(--card);border-radius:10px;padding:12px;display:flex;flex-direction:column;align-items:center;gap:10px;border:1px solid #eef2f5}
  video{width:100%;height:300px;background:#000;border-radius:8px;object-fit:cover;border:1px solid #e6ecef}
  canvas{display:none}
  .controls{display:flex;gap:8px;width:100%}
  .controls button, .controls input[type=file], .manual-btn{
    flex:1;padding:10px;border-radius:8px;border:1px solid #d6e1df;background:white;cursor:pointer;font-weight:600;color:#023;box-shadow:none
  }
  .controls button.primary{background:var(--accent);color:white;border:none}
  .small{font-size:13px;padding:8px}
  /* right column */
  .result-card{background:var(--card);border-radius:10px;padding:14px;border:1px solid #eef2f5;min-height:360px}
  .status{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  .pill{padding:6px 10px;border-radius:999px;background:#eef9f4;color:green;font-weight:700;font-size:13px}
  .danger{background:#fff0f0;color:var(--danger);border:1px solid #ffd6d6}
  .meta{font-size:13px;color:#444;margin-bottom:10px}
  pre#ocr{background:#0b1220;color:#cfe8d9;padding:10px;border-radius:8px;white-space:pre-wrap;max-height:180px;overflow:auto;}
  .card-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:6px}
  .card-item{flex:1;min-width:180px;background:#f8fafb;padding:8px;border-radius:8px;border:1px solid #eef2f5}
  .search-row{display:flex;gap:8px;margin-top:10px}
  input[type=text]{padding:10px;border-radius:8px;border:1px solid #dde6e0;flex:1}
  .note{font-size:12px;color:#666;margin-top:8px}
  footer{grid-column:1/-1;text-align:center;color:#666;font-size:12px;margin-top:10px}
  @media (max-width:880px){.app{grid-template-columns:1fr;}.cam-card video{height:240px}}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="NAFDAC scanner and verifier">
    <header>
      <div>
        <h1>NAFDAC Scanner & Verifier</h1>
        <p class="hint">Scan a drug pack or upload an image — the app will attempt to read the NRN and verify it against <code>nafdac_data.json</code>.</p>
      </div>
      <div style="text-align:right">
        <div style="font-size:12px;color:#666">Tip: Run this via a local server (see bottom)</div>
      </div>
    </header>

    <!-- Left: Camera & Controls -->
    <section class="cam-card" aria-label="Camera controls">
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas"></canvas>

      <div class="controls">
        <button id="startBtn" class="primary">Start Camera</button>
        <button id="stopBtn">Stop</button>
      </div>

      <div class="controls">
        <input id="fileInput" type="file" accept="image/*" />
        <button id="scanBtn" class="primary">Scan Image</button>
      </div>

      <div style="width:100%;display:flex;gap:8px">
        <button id="captureBtn" class="small">Capture Frame</button>
        <button id="ocrBtn" class="small">OCR from Frame</button>
        <button id="clearBtn" class="small">Clear</button>
      </div>

      <div class="note">Progress: <span id="progressLabel">idle</span></div>
      <div class="note">OCR results (truncated):</div>
      <pre id="ocr" aria-live="polite">— no OCR yet —</pre>
    </section>

    <!-- Right: Results -->
    <aside class="result-card" aria-label="Results & verification">
      <div class="status">
        <div id="verifiedPill" class="pill" style="display:none"></div>
        <div id="errorPill" class="pill danger" style="display:none"></div>
      </div>

      <div class="meta">
        <strong>Detected / Verified NRN:</strong> <span id="detectedNRN">—</span><br>
        <strong>Records loaded:</strong> <span id="datasetCount">0</span>
      </div>

      <div class="search-row">
        <input id="manualInput" type="text" placeholder="Type/paste NRN manually (e.g. A4-100160)" />
        <button id="manualVerify" class="primary">Verify</button>
      </div>

      <div id="resultArea" style="margin-top:12px;display:none">
        <h3 id="prodName" style="margin:0 0 6px 0;"></h3>
        <div class="card-row">
          <div class="card-item"><strong>NRN</strong><div id="resNRN"></div></div>
          <div class="card-item"><strong>Status</strong><div id="resStatus"></div></div>
          <div class="card-item"><strong>Applicant</strong><div id="resApplicant"></div></div>
          <div class="card-item"><strong>Manufacturer</strong><div id="resManufacturer"></div></div>
          <div class="card-item"><strong>Approval Date</strong><div id="resApproval"></div></div>
          <div class="card-item"><strong>Expiry Date</strong><div id="resExpiry"></div></div>
        </div>
        <div class="note" id="expiryNote"></div>
        <div style="margin-top:12px"><strong>Full OCR text:</strong></div>
        <pre id="fullOCR" style="max-height:220px;overflow:auto;background:#fff;padding:10px;border-radius:8px;border:1px solid #eef2f5"></pre>
      </div>

      <div id="notFound" style="display:none;margin-top:12px;color:var(--danger)">
        <strong>❌ Not found in dataset.</strong>
        <div class="note">This could be a fake item, OCR error, or the record isn't present in your <code>nafdac_data.json</code>.</div>
      </div>
    </aside>

    <footer>
      Run with a local HTTP server (example): <code>python3 -m http.server 8000</code> then open <code>http://localhost:8000</code>.
    </footer>
  </div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
<script>
(async () => {
  // Elements
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const captureBtn = document.getElementById('captureBtn');
  const ocrBtn = document.getElementById('ocrBtn');
  const scanBtn = document.getElementById('scanBtn');
  const fileInput = document.getElementById('fileInput');
  const ocrPre = document.getElementById('ocr');
  const progressLabel = document.getElementById('progressLabel');

  const detectedNRNSpan = document.getElementById('detectedNRN');
  const datasetCountSpan = document.getElementById('datasetCount');
  const verifiedPill = document.getElementById('verifiedPill');
  const errorPill = document.getElementById('errorPill');

  const manualInput = document.getElementById('manualInput');
  const manualVerify = document.getElementById('manualVerify');

  const resultArea = document.getElementById('resultArea');
  const notFoundDiv = document.getElementById('notFound');
  const prodName = document.getElementById('prodName');
  const resNRN = document.getElementById('resNRN');
  const resStatus = document.getElementById('resStatus');
  const resApplicant = document.getElementById('resApplicant');
  const resManufacturer = document.getElementById('resManufacturer');
  const resApproval = document.getElementById('resApproval');
  const resExpiry = document.getElementById('resExpiry');
  const expiryNote = document.getElementById('expiryNote');
  const fullOCR = document.getElementById('fullOCR');

  let stream = null;
  let dataset = [];
  let tesseractWorker = null;
  let lastOCRtext = '';

  // Load dataset from root JSON file
  async function loadDataset() {
    try {
      const res = await fetch('nafdac_data.json');
      if (!res.ok) throw new Error('HTTP ' + res.status);
      dataset = await res.json();
      datasetCountSpan.textContent = dataset.length || 0;
      console.log('Loaded dataset records:', dataset.length);
    } catch (err) {
      console.error('Failed loading nafdac_data.json:', err);
      datasetCountSpan.textContent = '0 (failed to load)';
    }
  }
  await loadDataset();

  // init or reuse tesseract worker
  async function getTesseractWorker() {
    if (tesseractWorker) return tesseractWorker;
    const { createWorker } = Tesseract;
    const worker = createWorker({
      logger: m => {
        const s = (m.progress || 0) * 100;
        if (m.status) progressLabel.textContent = `${m.status} ${s?Math.round(s)+'%':''}`;
      }
    });
    await worker.load();
    await worker.loadLanguage('eng');
    await worker.initialize('eng');
    // restrict characters a bit
    await worker.setParameters({
      tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 -/:.',
    });
    tesseractWorker = worker;
    return worker;
  }

  // start/stop camera
  startBtn.addEventListener('click', async () => {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      video.srcObject = stream;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      progressLabel.textContent = 'camera started';
    } catch (err) {
      progressLabel.textContent = 'camera error';
      console.error(err);
      alert('Camera access error: ' + err.message);
    }
  });

  stopBtn.addEventListener('click', () => {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      video.srcObject = null;
      stream = null;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      progressLabel.textContent = 'camera stopped';
    }
  });

  // capture current video frame to canvas, returns blob/imageDataURL
  function captureFrame() {
    const w = video.videoWidth || 1280;
    const h = video.videoHeight || 720;
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);

    // optional pre-processing: increase contrast / grayscale
    const img = ctx.getImageData(0,0,w,h);
    const d = img.data;
    // simple threshold boost (light)
    for (let i=0;i<d.length;i+=4) {
      const r = d[i], g = d[i+1], b = d[i+2];
      const v = (r + g + b) / 3;
      // boost contrast slightly
      const outv = v > 150 ? 255 : v < 80 ? 0 : Math.max(0, Math.min(255, (v - 80) * 1.3));
      d[i] = d[i+1] = d[i+2] = outv;
    }
    ctx.putImageData(img,0,0);

    return canvas.toDataURL('image/png');
  }

  captureBtn.addEventListener('click', () => {
    if (!stream) return alert('Start camera first or upload an image');
    const dataUrl = captureFrame();
    ocrPre.textContent = '[captured frame ready — press "OCR from Frame"]';
    lastOCRtext = '';
    progressLabel.textContent = 'frame captured';
  });

  // OCR from current canvas frame
  ocrBtn.addEventListener('click', async () => {
    if (!stream && !canvas.width) return alert('No frame available — start camera and capture or upload an image.');
    await doOCRFromCanvas();
  });

  // OCR from camera capture OR uploaded file (scanBtn)
  scanBtn.addEventListener('click', async () => {
    // if file selected, OCR file, else capture current frame
    if (fileInput.files && fileInput.files.length) {
      const file = fileInput.files[0];
      await doOCRFromFile(file);
    } else {
      if (!stream) return alert('Start camera or upload an image.');
      captureFrame(); // draw to canvas
      await doOCRFromCanvas();
    }
  });

  // OCR flow functions
  async function doOCRFromCanvas() {
    progressLabel.textContent = 'initializing OCR...';
    const worker = await getTesseractWorker();
    try {
      const { data } = await worker.recognize(canvas);
      handleOCRResult(data.text || '');
    } catch (err) {
      console.error('OCR error:', err);
      progressLabel.textContent = 'OCR error';
      alert('OCR error: ' + err.message);
    }
  }

  async function doOCRFromFile(file) {
    progressLabel.textContent = 'loading image...';
    // draw file to canvas
    const img = new Image();
    img.onload = async () => {
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img,0,0);
      progressLabel.textContent = 'image loaded';
      await doOCRFromCanvas();
    };
    img.onerror = e => {
      console.error('image load error', e);
      alert('Failed to read image file.');
    };
    img.src = URL.createObjectURL(file);
  }

  // Main OCR handler: find NRN candidates, verify
  function handleOCRResult(text) {
    lastOCRtext = (text || '').trim();
    ocrPre.textContent = lastOCRtext || '[empty OCR]';
    fullOCR.textContent = lastOCRtext || '[no OCR text]';
    progressLabel.textContent = 'parsing text';
    // find NRN using robust heuristics
    const nrn = extractNRNFromText(lastOCRtext);
    if (nrn) {
      detectedNRNSpan.textContent = nrn;
      progressLabel.textContent = 'NRN detected: ' + nrn;
      verifyNRN(nrn, lastOCRtext);
    } else {
      detectedNRNSpan.textContent = '—';
      progressLabel.textContent = 'no NRN found';
      showNotFound();
    }
  }

  // Try to find NRN:
  // 1) look for "NAFDAC" followed by token
  // 2) look for patterns like A4-100160 or A4/6238 or ABC-12345
  // 3) search for dataset NRNs contained in OCR text (fallback)
  function extractNRNFromText(text) {
    if (!text) return null;
    const t = text.toUpperCase().replace(/\r/g,' ').replace(/\n/g,' ');
    // 1) NAFDAC ... capture token after it
    const rx1 = /NAFDAC\s*(?:REG(?:ISTRATION)?\.?)?(?:\s*NO\.?)?\s*[:\-]?\s*([A-Z0-9\/\-]{4,20})/i;
    const m1 = t.match(rx1);
    if (m1 && m1[1]) return normalizeNRN(m1[1]);

    // 2) common token pattern (letters/digits, hyphen or slash, digits)
    const rx2 = /([A-Z0-9]{1,4}[-\/][0-9]{3,7})/g;
    const matches = [...t.matchAll(rx2)].map(m=>m[1]);
    if (matches.length) {
      // try return the first candidate that exists in dataset
      for (const c of matches) {
        const n = normalizeNRN(c);
        if (findRecordByNRN(n)) return n;
      }
      // otherwise return first candidate as best-effort
      return normalizeNRN(matches[0]);
    }

    // 3) brute force: check each NRN in dataset if present in text
    for (const rec of dataset) {
      if (!rec.NRN) continue;
      const n = normalizeNRN(rec.NRN);
      if (t.includes(n)) return n;
    }

    return null;
  }

  function normalizeNRN(s) {
    if (!s) return '';
    return String(s).toUpperCase().replace(/\s+/g,'').replace(/[\.]/g,'');
  }

  function findRecordByNRN(nrn) {
    if (!nrn) return null;
    const n = normalizeNRN(nrn);
    return dataset.find(d => d.NRN && normalizeNRN(d.NRN) === n) || null;
  }

  // verify NRN and render results
  function verifyNRN(nrn, ocrText = '') {
    clearResults();
    const record = findRecordByNRN(nrn);
    if (!record) {
      showNotFound(ocrText);
      return;
    }
    // show found
    showRecord(record, ocrText);
  }

  // show record UI
  function showRecord(rec, ocrText='') {
    notFoundDiv.style.display = 'none';
    resultArea.style.display = 'block';
    prodName.textContent = rec['Product name'] || '(no name)';
    resNRN.textContent = rec.NRN || '';
    resStatus.textContent = rec.Status || '';
    resApplicant.textContent = rec['Applicant Name'] || '';
    resManufacturer.textContent = (rec['Manufacturer Name'] || '') + (rec['Manufacturer Country'] ? ' ('+rec['Manufacturer Country']+')' : '');
    resApproval.textContent = rec['Approval Date'] || '—';
    resExpiry.textContent = rec['Expiry Date'] || '—';
    fullOCR.textContent = ocrText || lastOCRtext || '[no OCR text]';

    // expiry check
    const expiryDate = parseDateString(rec['Expiry Date']);
    if (expiryDate && !isNaN(expiryDate.getTime())) {
      const now = new Date();
      if (now > expiryDate) {
        expiryNote.innerHTML = `<strong style="color:var(--danger)">EXPIRED</strong> — expired on ${expiryDate.toDateString()}`;
        errorPill.style.display = 'inline-block';
        errorPill.textContent = 'EXPIRED';
        verifiedPill.style.display = 'none';
      } else {
        const days = Math.ceil((expiryDate - (new Date())) / (1000*60*60*24));
        expiryNote.innerHTML = `<strong style="color:green">Valid</strong> — expires on ${expiryDate.toDateString()} (${days} day(s) left)`;
        verifiedPill.style.display = 'inline-block';
        verifiedPill.textContent = 'VERIFIED';
        errorPill.style.display = 'none';
      }
    } else {
      expiryNote.innerHTML = `<span style="color:#666">No expiry date available in dataset.</span>`;
      verifiedPill.style.display = 'inline-block';
      verifiedPill.textContent = 'FOUND';
      errorPill.style.display = 'none';
    }
    detectedNRNSpan.textContent = normalizeNRN(rec.NRN);
    progressLabel.textContent = 'record found';
  }

  function showNotFound(ocrText='') {
    resultArea.style.display = 'none';
    notFoundDiv.style.display = 'block';
    errorPill.style.display = 'inline-block';
    errorPill.textContent = 'NOT FOUND';
    verifiedPill.style.display = 'none';
    detectedNRNSpan.textContent = '—';
    fullOCR.textContent = ocrText || lastOCRtext || '[no OCR]';
    progressLabel.textContent = 'no match in dataset';
  }

  function clearResults() {
    resultArea.style.display = 'none';
    notFoundDiv.style.display = 'none';
    verifiedPill.style.display = 'none';
    errorPill.style.display = 'none';
    progressLabel.textContent = 'idle';
  }

  // manual verify
  manualVerify.addEventListener('click', () => {
    const val = manualInput.value.trim();
    if (!val) return alert('Enter NRN first');
    const nrn = normalizeNRN(val);
    verifyNRN(nrn);
  });

  // parse dates safely (handles formats like 12/16/2026 or 2021-12-17)
  function parseDateString(s) {
    if (!s) return null;
    // try Date constructor first
    let d = new Date(s);
    if (!isNaN(d.getTime())) return d;
    // common formats: MM/DD/YYYY or DD/MM/YYYY or YYYY-MM-DD
    const parts = String(s).trim().split(/[\/\-\.\s]/).filter(Boolean);
    if (parts.length === 3) {
      // guess: if first part length==4 -> year-first
      if (parts[0].length === 4) {
        d = new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
      } else {
        // treat as MM/DD/YYYY (common in dataset)
        d = new Date(Number(parts[2]), Number(parts[0]) - 1, Number(parts[1]));
      }
      if (!isNaN(d.getTime())) return d;
    }
    return null;
  }

  // file upload quick OCR
  fileInput.addEventListener('change', async (e) => {
    if (!fileInput.files.length) return;
    progressLabel.textContent = 'image selected';
    // optionally auto-scan
    // await doOCRFromFile(fileInput.files[0]);
  });

  // clear UI
  document.getElementById('clearBtn').addEventListener('click', () => {
    clearResults();
    ocrPre.textContent = '— no OCR yet —';
    fullOCR.textContent = '';
    detectedNRNSpan.textContent = '—';
    manualInput.value = '';
  });

  // graceful worker cleanup on page unload
  window.addEventListener('unload', async () => {
    if (tesseractWorker) {
      try { await tesseractWorker.terminate(); } catch(e){/*ignore*/ }
    }
    if (stream) stream.getTracks().forEach(t=>t.stop());
  });

  // small UX: disable stop initially
  stopBtn.disabled = true;

})();
</script>
</body>
</html>